{% extends 'base.html' %}
{% block content %}
<div class="full-page">
    <div class="card">
        <span class="q-badge">{{ q.id }}</span>
        <h1 style="margin-top: 0;">Který text vytvořila AI?</h1>
        
        {% set user_vote = session.get('voted_' ~ state.poll_id) %}
        
        <div id="options-container">
            {% for opt in q.options %}
            <form action="{{ url_for('vote', oid=loop.index0) }}" method="post">
                <button type="submit" 
                    class="option-btn {% if user_vote == loop.index0 %}selected{% endif %}" 
                    id="btn-{{loop.index0}}"
                    {% if state.phase == 'results' %}disabled{% endif %}>
                    {{ opt.text }}
                </button>
            </form>
            {% endfor %}
        </div>
        <div id="status-msg" style="text-align: center; font-weight: bold; margin-top: 20px;"></div>
    </div>
</div>

<script>
    const pollId = "{{ state.poll_id }}";
    const userVote = "{{ user_vote if user_vote != None else 'None' }}";

    async function checkState() {
        const r = await fetch('/api/state');
        const d = await r.json();
        
        if (d.poll_id !== pollId) { location.reload(); }

        if (d.phase === 'results') {
            document.querySelectorAll('.option-btn').forEach((btn, i) => {
                btn.disabled = true;
                if (d.correct_indices.includes(i)) {
                    btn.classList.add('correct');
                    if (userVote == i) document.getElementById('status-msg').innerHTML = "✅ SPRÁVNĚ! Odhalil jste AI.";
                } else if (userVote == i) {
                    btn.classList.add('wrong');
                    document.getElementById('status-msg').innerHTML = "❌ CHYBA! Toto napsal člověk.";
                }
            });
            if (userVote === 'None') document.getElementById('status-msg').innerText = "Hlasování skončilo (nehlasoval jste).";
        }
    }
    setInterval(checkState, 2000);
</script>
{% endblock %}
