{% extends 'base.html' %}
{% block content %}
<div class="full-page">
    <div style="margin-bottom: 30px;">
        <a href="/admin/nav/prev" class="btn-nav secondary">← PŘEDCHOZÍ</a>
        <a href="/admin/nav/toggle" class="btn-nav">
            {% if state.phase == 'voting' %}ODHALIT VÝSLEDKY{% else %}ZPĚT K HLASOVÁNÍ{% endif %}
        </a>
        <a href="/admin/nav/next" class="btn-nav secondary">DALŠÍ →</a>
    </div>

    <div class="card" style="max-width: 1000px; text-align: center;">
        <span class="q-badge">ADMIN PANEL - {{ q.id }}</span>
        <h1 id="accuracy-title" style="font-size: 4rem; margin: 10px 0;">???</h1>
        <p style="text-transform: uppercase; letter-spacing: 2px; opacity: 0.7;">Úspěšnost skupiny</p>
        
        <div style="height: 400px; margin-top: 30px;">
            <canvas id="adminChart"></canvas>
        </div>
    </div>

    <div style="margin-top: 40px; width: 100%; max-width: 900px; opacity: 0.8;">
        <h3>Náhled textů (Otázka {{ q.id }}):</h3>
        {% for o in q.options %}
            <div style="padding: 10px; border-left: 4px solid {% if o.ai %}var(--ai){% else %}#334155{% endif %}; margin-bottom: 10px; background: rgba(255,255,255,0.03);">
                <strong>Text {{ loop.index }}:</strong> {{ o.text[:150] }}... {% if o.ai %}<strong>(AI)</strong>{% endif %}
            </div>
        {% endfor %}
    </div>
</div>

<script>
    let chart;
    async function updateStats() {
        const r = await fetch('/api/stats');
        const d = await r.json();
        
        document.getElementById('accuracy-title').innerText = d.phase === 'results' ? d.accuracy : "???";

        const bgColors = d.votes.map((_, i) => {
            if (d.phase === 'results') {
                return d.correct_indices.includes(i) ? '#10b981' : '#ef4444';
            }
            return '#6366f1';
        });

        if (!chart) {
            chart = new Chart(document.getElementById('adminChart'), {
                type: 'bar',
                data: { labels: d.labels, datasets: [{ data: d.votes, backgroundColor: bgColors, borderRadius: 10 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                        x: { ticks: { color: '#fff', font: { size: 16, weight: 'bold' } }, grid: { display: false } }
                    }
                }
            });
        } else {
            chart.data.labels = d.labels;
            chart.data.datasets[0].data = d.votes;
            chart.data.datasets[0].backgroundColor = bgColors;
            chart.update();
        }
    }
    setInterval(updateStats, 1500);
</script>
{% endblock %}
