{% extends 'base.html' %}
{% block content %}
<div class="full-page">
    <div class="card" style="max-width: 800px;">
        <h1>Ovládání hlasování</h1>
        
        {% if not poll.is_open %}
        <form action="{{ url_for('admin_action') }}" method="post">
            <input type="hidden" name="action" value="start">
            <div style="text-align: left; margin-bottom: 20px;">
                <label>Otázka:</label>
                <input type="text" name="question" value="Který text vytvořila AI?" style="width:100%; padding:12px; margin:10px 0; border-radius:8px; background:#0b0f19; border:1px solid #333; color:white;">
                
                <label>Možnosti:</label>
                <div id="opts">
                    <input type="text" name="options" value="Text 1" style="width:100%; padding:10px; margin-bottom:5px; border-radius:8px; background:#0b0f19; border:1px solid #333; color:white;">
                    <input type="text" name="options" value="Text 2" style="width:100%; padding:10px; margin-bottom:5px; border-radius:8px; background:#0b0f19; border:1px solid #333; color:white;">
                </div>
                <button type="button" onclick="add()" style="background:#333; margin-top:5px; padding:5px 10px; font-size:0.8rem;">+ Další možnost</button>
            </div>
            <button type="submit" style="background:var(--success); width:100%;" onclick="window.scrollTo(0, document.body.scrollHeight);">SPUSTIT HLASOVÁNÍ</button>
        </form>
        {% else %}
        <form action="{{ url_for('admin_action') }}" method="post">
            <input type="hidden" name="action" value="stop">
            <h2 style="color:var(--success)">● Probíhá hlasování: {{ poll.question }}</h2>
            <button type="submit" style="background:var(--danger); width:100%;">ZASTAVIT A UZAVŘÍT</button>
        </form>
        {% endif %}
    </div>
</div>

<!-- Stats div below -->
<div class="full-page" style="background: #000;">
    <h1>Živé výsledky</h1>
    <div style="width: 90%; height: 70vh;">
        <canvas id="adminChart"></canvas>
    </div>
</div>

<script>
    function add() {
        const i = document.createElement('input');
        i.name = 'options';
        i.style = "width:100%; padding:10px; margin-bottom:5px; border-radius:8px; background:#0b0f19; border:1px solid #333; color:white;";
        i.placeholder = "Nová možnost";
        document.getElementById('opts').appendChild(i);
    }

    let chart;
    async function refresh() {
        const r = await fetch('/api/data');
        const d = await r.json();
        if (!chart) {
            chart = new Chart(document.getElementById('adminChart'), {
                type: 'bar',
                data: { labels: d.stats.map(s=>s.label), datasets: [{data: d.stats.map(s=>s.count), backgroundColor: '#10b981'}] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: {legend:{display:false}}}
            });
        } else {
            chart.data.labels = d.stats.map(s=>s.label);
            chart.data.datasets[0].data = d.stats.map(s=>s.count);
            chart.update();
        }
    }
    setInterval(refresh, 1000);
</script>
{% endblock %}
